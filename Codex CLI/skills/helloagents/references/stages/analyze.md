# 项目分析模块

本模块定义项目分析阶段的详细规则，在轻量迭代或标准开发模式下执行。


## 目录
- 模块入口
- 执行模式适配
- 执行流程
- 用户选择处理

---

## 模块入口

### 触发条件

```yaml
前置条件: 需求评估阶段复杂度判定为轻量迭代或标准开发模式
加载时机: 用户确认执行后加载
特点: 扫描目录，获取项目上下文
```

### 状态设置

```yaml
设置时机: 本模块被加载时
设置内容:
  - CURRENT_STAGE = ANALYZE
```

---

## 执行模式适配

<mode_adaptation>

### 模式行为

```yaml
读取状态变量: WORKFLOW_MODE

"交互模式"（INTERACTIVE，默认）:
  执行下方"执行流程"步骤1-6
  遇到需要确认的场景: 按 G3 场景内容规则（确认）输出，等待用户选择
  完成后: 自动流转到方案设计阶段（不输出阶段完成状态）

"全授权模式"（AUTO_FULL，~auto命令）:
  静默执行下方"执行流程"步骤1-6（不输出中间状态）
  遇到需要确认的场景: 自动选择默认选项（如跳过初始化、继续大型项目分析）
  完成后: 自动流转到方案设计阶段

"规划模式"（AUTO_PLAN，~plan命令）:
  静默执行下方"执行流程"步骤1-6（不输出中间状态）
  完成后: 自动流转到方案设计阶段
```

### 阶段流转

```yaml
分析完成后:
  设置: CURRENT_STAGE = DESIGN
  读取并执行: references/stages/design.md
  传递: 项目上下文信息供方案设计使用
```

</mode_adaptation>

---

## 执行流程

### 步骤1: 知识库开关检查

按 G1 "KB开关检查规则" 和 "KB_SKIPPED 变量生命周期" 执行。

```yaml
设置规则:
  KB_CREATE_MODE = 0: 设置 KB_SKIPPED = true
  KB_CREATE_MODE = 1/2/3: 设置 KB_SKIPPED = false

传递: 后续阶段（design, develop）直接使用此值（按 G1 "KB_SKIPPED 变量生命周期"）
```

### 步骤2: 检查知识库状态

```yaml
前置条件: KB_SKIPPED = false（仅开关=1/2/3时执行）
判定条件: 工作目录存在代码文件 且 需求不是"新建项目"

处理规则: 按 G1 "KB开关检查规则" 中的 KB_CREATE_MODE 值执行对应操作

知识库状态显示:
  KB_CREATE_MODE = 0: "⚠️ 已跳过（开关关闭）"
  KB_CREATE_MODE = 1/2/3 且存在: "✅ 已加载"
  KB_CREATE_MODE = 1 且不存在: "⚠️ 不存在（建议执行 ~init）"
  KB_CREATE_MODE = 2 且不存在: 编程任务 → "🔄 已自动创建"，非编程 → 同1
  KB_CREATE_MODE = 3 且不存在: "🔄 已自动创建"

详细规则: 参考 references/services/knowledge.md
```

### 步骤3: 获取项目上下文

```yaml
KB_SKIPPED = true: 直接扫描代码库
KB_SKIPPED = false: 先检查知识库 → 不足则扫描代码库

目的: 为方案设计提供完整项目上下文
```

### 步骤4: 提取关键目标与成功标准

<goal_extraction>

**要点:**
1. 从完整需求中提炼核心目标
2. 明确可验证的成功标准
3. 识别关键约束条件

</goal_extraction>

```yaml
执行内容:
  - 提取关键目标: 从完整需求中提炼核心目标
  - 定义成功标准: 明确可验证的成功标准
```

### 步骤5: 项目分析与技术准备

<technical_analysis>

**要点:**
1. 定位与需求相关的模块和文件
2. 分析现有代码结构和依赖关系
3. 识别潜在的技术风险和约束

</technical_analysis>

```yaml
执行内容:
  - 定位相关模块
  - 质量检查: 标记过时信息，扫描安全风险和代码异味
  - 问题诊断: 分析日志或错误信息（如有）
  - 技术信息收集（如需要）: 使用联网搜索或MCP工具获取最新文档和最佳实践

外部工具调用（如需要）:
  触发条件: 需要获取最新技术文档、API参考、最佳实践等信息
  调用规则: 按 G6 外部工具状态隔离规则执行
  状态保存: 调用前保存 SUSPENDED_STAGE = ANALYZE
  状态恢复: 工具完成后恢复阶段状态，继续分析
  输出包装: 按 G6 Shell包装规则处理工具输出

输出物: 项目上下文信息（技术栈、模块结构、质量问题、技术约束）供方案设计使用
```

### 步骤6: 大型项目检测

> 脚本路径、存在性检查、错误恢复规则见 [references/rules/tools.md](../rules/tools.md)

**脚本调用（可选）:** `project_stats.py`（用于获取精确的项目统计数据）

```yaml
检测规则: 按 references/rules/scaling.md 判定

检测到大型项目:
  "交互模式": 按 G3 场景内容规则（确认）输出，等待用户选择
  "全授权模式"/"规划模式": 自动继续，在分析结果中标注"大型项目，已启用分批处理"

未检测到大型项目: 继续阶段流转
```

---

## 用户选择处理

> 本章节定义项目分析阶段需要用户确认的场景，供 G3 输出格式统一提取。

### 场景: 知识库状态确认（知识库不存在且需用户确认）

```yaml
触发条件:
  - KB_CREATE_MODE = 1 且知识库不存在
  - KB_CREATE_MODE = 2 且非编程任务且知识库不存在

内容要素:
  - 检测结果: 知识库不存在
  - 建议操作: 执行 ~init 初始化知识库

选项:
  执行初始化: 转发到 ~init 命令
  跳过: 设置 KB_SKIPPED = true，继续项目分析
  取消: 按 G7 状态重置协议执行
```

### 场景: 大型项目确认

```yaml
触发条件: 检测到大型项目（按 references/rules/scaling.md 判定）

内容要素:
  - 检测结果: 项目规模统计（源文件数/代码行数/模块数）
  - 处理说明: 将启用分批处理策略

选项:
  继续: 按大型项目策略继续分析
  取消: 按 G7 状态重置协议执行
```
