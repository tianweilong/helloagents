# 方案设计模块

本模块定义方案构思和详细规划的执行规则，在轻量迭代或标准开发模式下执行。


## 目录
- 模块入口
- 执行模式适配
- 执行流程
- 用户选择处理

---

## 模块入口

### 触发条件

```yaml
前置条件: 项目分析阶段完成
加载时机: 项目分析完成后自动流转
特点: 生成方案包（proposal.md + tasks.md）
```

### 状态设置

```yaml
设置时机: 本模块被加载时
设置内容:
  - CURRENT_STAGE = DESIGN
```

---

## 执行模式适配

<mode_adaptation>

### 模式行为

```yaml
读取状态变量: WORKFLOW_MODE

"交互模式"（INTERACTIVE，默认）:
  复杂任务: 输出方案对比 → 等待用户选择 → 详细规划 → 输出总结 → 等待确认
  简单任务: 直接详细规划 → 输出总结 → 等待确认

"全授权模式"（AUTO_FULL，~auto命令）:
  复杂任务: 静默选择推荐方案 → 详细规划 → 自动流转到开发实施阶段（不输出阶段完成状态）
  简单任务: 静默详细规划 → 自动流转到开发实施阶段（不输出阶段完成状态）

"规划模式"（AUTO_PLAN，~plan命令）:
  复杂任务: 静默选择推荐方案 → 详细规划 → 输出整体总结 → 结束
  简单任务: 静默详细规划 → 输出整体总结 → 结束
```

### 阶段流转

```yaml
IF WORKFLOW_MODE = INTERACTIVE:
  输出: 按 G3 场景内容规则（完成）输出方案设计结果
  **STOP HERE. Do NOT proceed to next stage until user confirms.**
  等待: 用户确认后方可继续
  用户确认后:
    IF 方案包类型 = overview:
      说明: overview类型方案包不进入开发实施
      执行: 按 references/rules/package.md "Overview类型方案包生命周期" 处理
      后续: 归档方案包 → 输出完成 → 状态重置
    ELSE:
      设置: CURRENT_STAGE = DEVELOP
      设置: CREATED_PACKAGE = 本次创建的方案包路径
      读取并执行: references/stages/develop.md

IF WORKFLOW_MODE = AUTO_FULL:
  静默完成详细规划
  IF 方案包类型 = overview:
    说明: overview类型方案包不进入开发实施
    执行: 自动归档方案包
    后续: 在总结中标注"已归档overview方案包" → 状态重置
  ELSE:
    设置: CURRENT_STAGE = DEVELOP
    设置: CREATED_PACKAGE = 本次创建的方案包路径
    读取并执行: references/stages/develop.md

IF WORKFLOW_MODE = AUTO_PLAN:
  完成详细规划
  设置: CREATED_PACKAGE = 本次创建的方案包路径
  说明: 方案设计完成后，控制权返回 plan.md 执行流程级验收
  注意: 本阶段不直接进入开发实施，由 plan.md 决定流程终止
  后续: plan.md 步骤6（流程级验收）→ 输出规划命令完成结果 → 状态重置 → 流程终止
```

### 推荐方案自动选择（静默模式）

```yaml
选择策略:
  1. 评估所有方案的风险和收益
  2. 优先选择标记为"推荐"的方案
  3. 无明确推荐时，选择风险最低的方案

记录: 在方案包的 proposal.md 中记录选择理由
```

</mode_adaptation>

---

## 执行流程

### 步骤1: 模式分支判定

> 模式条件与升级规则见 G5

```yaml
轻量迭代:
  特点: 跳过多方案对比，直接确定方案
  流程: 跳过步骤2-4 → 直接进入步骤5（详细规划）

标准开发:
  特点: 复杂任务需要多方案对比
  流程: 完整执行步骤2-7
```

### 步骤2: 准备工作

**2.1 知识库检查与读取**

```yaml
知识库检查: 使用 analyze.md 已设置的 KB_SKIPPED 值（按 G1 "KB_SKIPPED 变量生命周期" 传递）
项目上下文获取:
  - KB_SKIPPED = false: 按 references/services/knowledge.md "项目上下文获取策略" 读取
  - KB_SKIPPED = true: 直接扫描代码库
```

**2.2 项目规模判定**

<project_scale_rules>

按 [references/rules/scaling.md](../rules/scaling.md) 规则判定，影响任务拆分粒度、文档创建策略、处理批次大小。

</project_scale_rules>

### 步骤3: 分析判定

**3.1 项目场景判定**

<project_context_analysis>

**推理过程（在 thinking 中完成）:**
1. 判断是新项目还是现有项目
2. 确定执行原则和填充深度

</project_context_analysis>

```yaml
项目场景:
  新项目:
    特征: 新项目初始化、从零开始、空目录
    执行原则:
      - 大胆创意，展现创造力
      - 包含产品视角分析（用户画像、场景、痛点、价值主张）
      - 范围模糊时主动补充合理功能
    填充深度: 完整填充（所有章节都填写）

  现有项目:
    特征: 在已有项目中修改、优化、修复
    执行原则:
      - 精准执行，尊重现有代码
      - 产品视角分析（仅当涉及用户交互时）
      - 考虑废代码处理、历史兼容性
    填充深度: 精简填充（必填章节 + 涉及的可选章节）

判断原则:
  - 根据用户需求决定交付内容的详细程度和复杂度
  - 范围模糊时: 高价值创意
  - 范围明确时: 精准高效
```

**3.2 方案类型判定**

<plan_type_rules>

按 G7 "方案包类型" 判定逻辑执行（包括 overview 类型的特殊处理）。

</plan_type_rules>

**3.3 任务复杂度判定**

<task_complexity_analysis>

**推理过程（在 thinking 中完成）:**
1. 检查是否为新项目初始化或重大功能重构
2. 分析是否涉及架构决策或技术选型
3. 评估是否存在多种实现路径
4. 判断影响范围（模块数、文件数）

</task_complexity_analysis>

```yaml
满足任一条件为复杂任务:
  - 新项目初始化或重大功能重构
  - 涉及架构决策或技术选型
  - 存在多种实现路径
  - 涉及多个模块(>1)或影响文件数>3
  - 用户明确要求多方案
```

### 步骤4: 方案构思与评估（仅复杂任务）

<solution_design_reasoning>

**推理过程（在 thinking 中完成）:**
1. 理解核心问题: 明确要解决什么问题，约束条件是什么
2. 探索技术路径: 列举所有可能的实现方式
3. 评估可行性: 逐一分析每个路径的技术可行性
4. 生成候选方案: 筛选出 2-3 个最可行的方案

</solution_design_reasoning>

**方案评估标准:** 优点、缺点、性能影响、可维护性、实现复杂度、风险评估（含EHRB）、成本估算、是否符合最佳实践

<solution_comparison>

**推理过程（在 thinking 中完成）:**
1. 逐一评估每个方案的优缺点、风险、成本
2. 横向对比各方案的关键差异
3. 确定推荐方案及理由

</solution_comparison>

```yaml
复杂任务（强制方案对比）:
  - 生成 2-3 个可行方案
  - 详细评估每个方案
  - 确定推荐方案和理由（推荐方案标题后加"推荐"标识）
  - 交互模式: 输出方案对比，询问用户选择
  - 静默模式: 选择推荐方案（不输出对比）

简单任务:
  - 直接确定唯一可行方案
  - 简要说明方案

方案选择后流转:
  交互模式:
    - 用户选择有效序号(1-N) → 进入步骤5
    - 用户拒绝所有方案 → 按 G3 场景内容规则（确认）输出
      用户选择处理:
        重新构思: 返回步骤4重新构思
        取消: 按 G7 状态重置协议执行
  静默模式:
    - 选择推荐方案 → 立即进入步骤5
```

### 步骤5: 详细规划

> 脚本路径、存在性检查、错误恢复规则见 [references/rules/tools.md](../rules/tools.md)

**脚本调用:**
```yaml
创建方案包: create_package.py <feature> [--type <implementation|overview>]
项目规模统计（可选）: project_stats.py
```

**目录/文件创建:** 按 G1 "目录/文件自动创建规则" 执行。

**脚本执行报告处理:**

<script_report_handling>
脚本执行报告处理流程:
1. 解析脚本输出的 JSON 执行报告
2. success=true 时继续后续步骤
3. success=false 时按 tools.md "AI降级接手流程" 执行
4. 质量检查 completed 步骤后再继续
</script_report_handling>

```yaml
解析 create_package.py 输出:
  success=true:
    - 继续执行后续填充步骤
    - 从 context.package_path 获取方案包路径

  success=false:
    - 执行: 按 references/rules/tools.md "脚本执行报告机制 - AI降级接手流程" 处理
    - 步骤1: 质量检查 completed 列表中已完成的步骤
    - 步骤2: 发现问题则修复
    - 步骤3: 按 pending 列表继续完成（参考 templates.md "AI接手时的文件创建指南"）
    - 步骤4: 设置 CREATED_PACKAGE 为方案包路径
```

**填充步骤:**
1. 调用 create_package.py 创建方案包目录和模板文件
2. 处理执行报告（按上述规则）
3. 根据填充深度填充 proposal.md 内容
4. 填充 tasks.md 内容（任务清单）
5. 设置 CREATED_PACKAGE 变量

### 步骤6: 方案包验收

> 按 G9 阶段验收标准（design）执行
> 脚本路径、存在性检查、错误恢复规则见 [references/rules/tools.md](../rules/tools.md)

```yaml
步骤:
  1. 调用 validate_package.py ${CREATED_PACKAGE}
  2. 检查验收结果

验收项:
  - 方案包结构完整 (阻断性): proposal.md + tasks.md 存在且非空
  - 方案包格式正确 (阻断性): 目录命名、文件格式符合规范
  - 任务清单可执行 (警告性): tasks.md 包含具体可执行任务

验收失败处理:
  "交互模式"（INTERACTIVE）:
    - 输出验证失败详情
    - 按 G3 场景内容规则（警告）输出
    - 提示用户修复或调整

  "全授权模式"/"规划模式"（AUTO_FULL/AUTO_PLAN）:
    阻断性失败:
      - 打破静默
      - 按 G3 场景内容规则（警告）输出验证失败详情
      - 等待用户决策（修复/强制继续/终止）
    警告性失败:
      - 记录到验收报告
      - 继续执行
```

### 步骤7: 输出与流转

```yaml
输出: 按"执行模式适配 - 阶段流转"规则执行

遗留方案包扫描（AUTO_PLAN模式流程结束时）:
  执行规则: 按 G7 "遗留方案包扫描" 执行
  扫描时机: 方案设计完成、流程即将结束时
  显示条件: 检测到≥1个遗留方案包
  详细规则: 参考 references/rules/package.md "遗留方案包处理"
```

---

## 用户选择处理

> 本章节定义方案设计阶段需要用户确认的场景，供 G3 输出格式统一提取。

### 场景: 方案选择（复杂任务）

```yaml
内容要素:
  - 方案列表: 2-3个可行方案的对比（优缺点、风险、成本）
  - 推荐方案: 标记推荐方案及推荐理由
  - 方案详情: 每个方案的技术路径和实现概要

选项:
  选择方案N: 选择对应序号的方案，进入详细规划
  重新构思: 返回方案构思，重新设计方案
  取消: 按 G7 状态重置协议执行
```

### 场景: 方案设计完成确认

```yaml
内容要素:
  - 方案包路径: 创建的方案包完整路径
  - 方案摘要: 选定方案的简要描述
  - 任务概览: tasks.md 中的任务数量和概要
  - 验收状态: 通过/部分通过（如有警告）

选项:
  立即执行: 进入开发实施阶段
  调整方案: 返回修改方案包内容
  取消: 按 G7 状态重置协议执行
```

### 场景: 方案包验收失败

```yaml
内容要素:
  - 验收结果: 失败项列表（阻断性/警告性）
  - 问题详情: 各失败项的具体问题描述
  - 修复建议: 针对各问题的修复建议

选项:
  修复: 根据建议修复方案包内容，重新验收
  强制继续: 忽略警告继续执行（仅警告性失败时可用）
  终止: 按 G7 状态重置协议执行
```
