# 需求评估模块

本模块定义需求评估阶段的详细规则，在路由判定为改动型意图时执行。


## 目录
- 模块入口
- 执行模式适配
- 执行流程
- 用户选择处理

---

## 模块入口

### 触发条件

```yaml
前置条件: G4 Layer 3 路由判定为改动型意图，或执行 ~auto/~plan 命令
加载时机: 路由完成后立即加载
特点: 不扫描用户项目目录，仅分析用户输入
```

### 状态设置

```yaml
设置时机: 本模块被加载时
设置内容:
  - CURRENT_STAGE = EVALUATE
```

### 禁止行为（CRITICAL）

- 禁止在需求评估阶段扫描用户项目目录或读取用户项目代码文件
- 禁止在需求评估阶段获取项目上下文
- 禁止在需求评估阶段检查知识库状态
- 需求评估阶段仅基于用户输入进行评估和追问

---

## 执行模式适配

<mode_adaptation>

### 模式行为

```yaml
读取状态变量: WORKFLOW_MODE

"交互模式"（INTERACTIVE，默认，普通输入触发）:
  评分<7: 输出追问 → 等待用户补充 → 重新评分
  评分≥7:
    输出: 需求摘要 + 复杂度判定结果 + 后续流程说明
    选项: 确认开始 / 调整模式 / 取消（不提供静默选项）
    确认后: 按复杂度进入对应流程，保持INTERACTIVE模式（每阶段交互）

"全授权模式"（AUTO_FULL，~auto命令触发）:
  评分<7: 打破静默，输出追问 → 等待用户补充
  评分≥7:
    输出: 需求摘要 + 复杂度判定结果 + 执行方式选项
    选项: 确认执行（静默）/ 交互执行 / 调整模式 / 取消
    用户选择:
      - 确认执行: 保持AUTO_FULL，静默执行直到流程完成
      - 交互执行: 设置 WORKFLOW_MODE = INTERACTIVE，每阶段交互

"规划模式"（AUTO_PLAN，~plan命令触发）:
  评分<7: 打破静默，输出追问 → 等待用户补充
  评分≥7:
    输出: 需求摘要 + 复杂度判定结果 + 执行方式选项
    选项: 确认执行（静默）/ 交互执行 / 调整模式 / 取消
    用户选择:
      - 确认执行: 保持AUTO_PLAN，静默执行直到方案设计完成
      - 交互执行: 设置 WORKFLOW_MODE = INTERACTIVE，每阶段交互
```

### 阶段流转

```yaml
用户选择后的流转:

  INTERACTIVE模式:
    确认开始:
      微调模式: 设置 CURRENT_STAGE = TWEAK，读取并执行 references/stages/tweak.md
      轻量迭代/标准开发: 设置 CURRENT_STAGE = ANALYZE，读取并执行 references/stages/analyze.md
    调整模式: 用户手动选择执行模式后，按上述规则流转
    取消: 按 G7 状态重置协议执行

  AUTO_FULL/AUTO_PLAN模式:
    确认执行: 按当前WORKFLOW_MODE静默执行后续流程
      微调模式: 设置 CURRENT_STAGE = TWEAK，读取并执行 references/stages/tweak.md
      轻量迭代/标准开发: 设置 CURRENT_STAGE = ANALYZE，读取并执行 references/stages/analyze.md
    交互执行: 设置 WORKFLOW_MODE = INTERACTIVE，按INTERACTIVE规则流转
    调整模式: 用户手动选择执行模式后，按上述规则流转
    取消: 按 G7 状态重置协议执行
```

</mode_adaptation>

---

## 执行流程

### 步骤1: 输入理解

<input_analysis>

**推理过程（在 thinking 中完成）:**
1. 分析用户显性意图
2. 挖掘隐含需求
3. 消除歧义（"那个"/"这个" 指什么？）
4. 口语转规范化描述

</input_analysis>

```yaml
输出: 规范化的需求描述（内部使用，不直接输出给用户）
```

### 步骤2: 需求完整性评分

<scoring_analysis>

**推理过程（在 thinking 中完成）:**
1. 逐项分析评分维度
2. 列举支持该评分的具体证据（引用用户原话）
3. 识别缺失的关键信息点
4. 计算总分
5. 判定是否需要追问

</scoring_analysis>

```yaml
评分原则:
  - 仅基于用户输入进行评分，不依赖项目上下文
  - 严格评分标准: 用户需求本身必须明确
  - 如果用户需求模糊（如"优化代码"、"改进交互"），必须追问

追问规则:
  - 只询问用户相关信息: 具体需求、业务逻辑、期望结果、优先级、约束条件
  - 不询问技术实现细节（这些在项目分析阶段获取）

评分维度 (总分 10 分):

  任务目标 (0-3分):
    评估焦点: 用户想要完成什么，核心意图是否清晰
    高分特征: 目标具体、意图明确、能回答"做什么"
    低分特征: 目标模糊、意图不清、无法确定要做什么

  完成标准 (0-3分):
    评估焦点: 如何判断任务完成，期望达到什么效果
    高分特征: 完成条件明确、预期效果清晰、能回答"做成什么样"
    低分特征: 无法判断何时算完成、效果描述模糊

  涉及范围 (0-2分):
    评估焦点: 任务涉及哪些内容，边界是否清楚
    高分特征: 范围明确、知道涉及什么和不涉及什么
    低分特征: 范围模糊、边界不清、可能遗漏或越界

  限制条件 (0-2分):
    评估焦点: 有哪些必须遵守的限制或约束
    高分特征: 关键限制已说明（技术、时间、兼容性等）
    低分特征: 存在潜在限制但未说明
    补充说明: 若任务本身无明显限制需求，未提及可视为"无特殊限制"

输出要求:
  - 所有需求评估输出必须包含评分详情（无论评分高低）
  - 展示内容: 总分（X/10）、各维度得分及简要依据
  - 状态表达: 根据得分情况使用正向/中性/待完善的表述
  - 得分依据: 引用用户原话或指出缺失点
```

### 步骤3: 评分后处理

```yaml
评分≥7分: 进入步骤4（安全分析）

评分<7分:
  输出: 按 G3 场景内容规则（追问）执行
  等待: 用户补充或明确决策
  追问循环: 用户补充 → 返回步骤2重新评分 → 评分≥7分则继续，评分<7分则再次追问
  用户选择"以现有需求继续": 直接进入步骤4
  用户选择"取消": 按 G7 状态重置协议执行
```

### 步骤4: 安全分析

<security_analysis>

**推理过程（在 thinking 中完成）:**
1. 识别潜在 EHRB（按 G2 EHRB 检测规则，包含关键词检测和语义分析）
2. 评估操作风险等级
3. 检查是否涉及敏感路径或数据

> 📌 EHRB 检测规则详见 G2 章节，包含:
> - 关键词检测列表（删除、清空、覆盖、格式化等）
> - 语义分析规则（批量操作、权限变更、配置修改等）

</security_analysis>

```yaml
检测到 EHRB: 标记风险，在复杂度判定中强制升级为标准开发
未检测到 EHRB: 继续步骤5
```

### 步骤5: 复杂度判定

> 📌 判定逻辑见 G4 "复杂度判定"
> 📌 判定结果对应 G5 执行模式

<complexity_analysis>

**推理过程（在 thinking 中完成）:**
1. 判断需求类型（新项目/重构/常规开发/技术变更）
2. 评估是否需要方案设计（实现方式是否明确）
3. 推断影响范围（单点/局部/跨模块）
4. 综合判定执行模式

</complexity_analysis>

```yaml
复杂度判定结果 → 执行模式映射（见 G5）:
  微调模式: 非新项目 + 实现方式明确 + 单点修改 + 无EHRB
  轻量迭代: 非新项目 + 需要简单设计 + 局部影响 + 无EHRB
  标准开发: 新项目/重大重构 或 需要完整设计 或 跨模块影响 或 涉及EHRB
```

### 步骤6: 输出触发响应

```yaml
输出: 按 G3 场景内容规则（确认）执行
内容: 从"用户选择处理 - 复杂度判定确认"提取
等待: 用户选择执行方式
后续: 按"执行模式适配 - 阶段流转"规则执行
```

---

## 用户选择处理

> 本章节定义需求评估阶段需要用户确认的场景，供 G3 输出格式统一提取。

### 场景: 需求追问（评分<7）

```yaml
内容要素:
  - 已识别需求: 从用户输入中提取的需求要点
  - 需求评分: 总分（X/10）及各维度得分与依据
  - 待补充问题: 针对低分维度的具体问题（≤5个）

选项:
  补充信息: 用户回答追问问题后返回步骤2重新评分
  以现有需求继续: 跳过追问，直接进入步骤4（安全分析）
  取消: 按 G7 状态重置协议执行
```

### 场景: 复杂度判定确认（INTERACTIVE模式，评分≥7）

```yaml
触发条件: WORKFLOW_MODE = INTERACTIVE（普通输入触发）

内容要素:
  - 需求摘要: 澄清后的完整需求描述
  - 需求评分: 总分（X/10）及各维度得分与依据
  - 复杂度判定: 判定结果（微调/轻量迭代/标准开发）及依据
  - 后续流程说明: 简要说明后续阶段（每阶段会输出结果并等待确认）

选项:
  确认开始: 按复杂度进入对应流程，保持交互模式
  调整模式: 允许用户手动选择执行模式（微调/轻量迭代/标准开发）
  取消: 按 G7 状态重置协议执行

注意: 此场景不提供"静默执行"选项，因为用户选择的是普通交互方式
```

### 场景: 复杂度判定确认（AUTO_FULL/AUTO_PLAN模式，评分≥7）

```yaml
触发条件: WORKFLOW_MODE = AUTO_FULL 或 AUTO_PLAN（~auto/~plan命令触发）

内容要素:
  - 需求摘要: 澄清后的完整需求描述
  - 需求评分: 总分（X/10）及各维度得分与依据
  - 复杂度判定: 判定结果（微调/轻量迭代/标准开发）及依据
  - 执行方式说明: 静默执行与交互执行的区别

选项:
  确认执行（静默）: 保持当前WORKFLOW_MODE，静默执行后续流程
  交互执行: 设置 WORKFLOW_MODE = INTERACTIVE，每阶段交互
  调整模式: 允许用户手动选择执行模式（微调/轻量迭代/标准开发）
  取消: 按 G7 状态重置协议执行

注意: 只有通过~auto/~plan命令触发时才提供静默执行选项
```
