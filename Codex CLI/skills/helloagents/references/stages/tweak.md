# 微调模式模块

本模块定义微调模式（≤2文件且≤30行改动）的执行规则。


## 目录
- 模块入口
- 执行模式适配
- 执行流程
- 升级判定
- 用户选择处理

---

## 模块入口

### 触发条件

```yaml
前置条件: 需求评估阶段复杂度判定为微调模式
加载时机: 用户确认进入微调模式后加载
特点: 直接修改代码，不创建方案包
```

### 状态设置

```yaml
设置时机: 本模块被加载时
设置内容:
  - CURRENT_STAGE = TWEAK
  - 保持 WORKFLOW_MODE 不变（继承自需求评估阶段）
  - 保持 STAGE_ENTRY_MODE = NATURAL
```

---

## 执行模式适配

<mode_adaptation>

### 模式行为

```yaml
读取状态变量: WORKFLOW_MODE

"交互模式"（INTERACTIVE，默认）:
  - 执行下方"执行流程"步骤1-7
  - 完成后输出结果，等待用户确认

"全授权模式"（AUTO_FULL，~auto命令）:
  - 静默执行下方"执行流程"步骤1-7（不输出中间状态）
  - 完成后在总结中列出微调结果
  - 不单独输出微调完成状态

"规划模式"（AUTO_PLAN，~plan命令）:
  - "微调模式"不适用于~plan命令（~plan需要生成方案包）
  - 如判定为微调，自动升级为"轻量迭代模式"，进入项目分析和方案设计
```

### 阶段流转

```yaml
微调完成后:
  执行: 按 G7 状态重置协议执行
  输出: 按 G3 场景内容规则（完成）输出
```

</mode_adaptation>

---

## 执行流程

> 触发条件见 G5 微调模式

### 步骤1: 知识库开关检查

按 G1 "KB开关检查规则" 和 "KB_SKIPPED 变量生命周期" 执行。

```yaml
微调模式特殊规则:
  - 无论 KB_CREATE_MODE 值如何，微调模式始终设置 KB_SKIPPED = true
  - CHANGELOG 更新: 按 G1 "目录/文件自动创建规则 - CHANGELOG.md" 处理
  - 原因: 微调模式是轻量级操作，不触发完整知识库创建
```

### 步骤2: 定位文件

```yaml
工具使用:
  - 文件查找: 根据需求定位目标文件
  - 内容搜索: 定位具体修改位置

定位失败处理:
  "交互模式": 询问用户确认
  "全授权模式": 输出错误，终止流程
```

### 步骤3: 直接修改

```yaml
执行规则:
  - 按需求直接修改代码
  - 单次修改≤30行
  - 不创建方案包

修改前检查:
  - 确认修改范围符合微调条件
  - 如超出范围: 触发升级判定（见下方"升级判定"章节）
```

### 步骤4: 知识库同步

```yaml
执行规则: 按 G1 "目录/文件自动创建规则" 和 references/services/knowledge.md "微调模式记录规则" 执行

例外规则（优先于 G1 KB_CREATE_MODE=3 的 ALWAYS 模式）:
  - 微调模式不触发完整知识库创建（即使 KB_CREATE_MODE=3）
  - 仅更新 CHANGELOG（如 helloagents/ 目录已存在）
  - 模块文档不存在时不创建
  - KB_CREATE_MODE=0 且 helloagents/ 目录不存在时跳过 CHANGELOG 更新

设计理由: 微调模式是轻量级操作，不应产生创建完整知识库的副作用
```

### 步骤5: 遗留方案包扫描

按 G7 "遗留方案包扫描" 执行。

### 步骤6: 微调后验收

> 按 G9 阶段验收标准（tweak）执行

```yaml
验收项:
  - 变更已应用 (警告性): 确认代码已修改
  - 基础功能正常 (警告性): 快速验证通过（如有测试）

验收方式:
  变更验证:
    - 确认目标文件已保存
    - 确认变更内容与预期一致
    - 检查是否有语法错误（如 IDE 或编译器报错）

  快速测试验证（如项目有测试）:
    触发条件: 项目存在测试框架或测试文件
    验证范围:
      - 优先: 与修改文件相关的单元测试
      - 次选: 项目的快速冒烟测试（如有）
    验证方式:
      - 执行测试命令，观察测试结果
      - 仅关注与本次修改相关的测试失败
    跳过条件:
      - 项目无测试框架
      - 无法识别相关测试文件
      - 测试执行超时（>30秒）

验收失败处理:
  警告性失败:
    - 记录到微调报告
    - 提示用户检查变更
    - 不阻塞流程完成

自动模式行为: 静默执行，问题记录到验收报告
```

### 步骤7: 输出与流转

```yaml
输出: 按"执行模式适配 - 阶段流转"规则执行
```

---

## 升级判定

<upgrade_decision>

**要点:**
1. 评估当前修改范围是否超出微调限制（文件数、行数）
2. 分析是否存在跨模块依赖
3. 按 G2 EHRB 检测规则判定是否涉及高风险操作
4. 综合判断是否需要升级到轻量迭代模式

</upgrade_decision>

```yaml
触发条件（执行过程中发现以下情况）:
  - 实际修改超过2个文件
  - 实际修改超过30行
  - 发现需要跨模块修改
  - 检测到 EHRB 风险（按 G2 EHRB 检测规则）

"交互模式"处理:
  按 G3 场景内容规则（确认）输出升级询问

  用户选择处理:
    升级:
      - 保存当前修改内容（不提交）
      - 保持 WORKFLOW_MODE = INTERACTIVE
      - 设置 CURRENT_STAGE = ANALYZE
      - 进入轻量迭代流程（项目分析 → 方案设计）
      - 方案包中包含已分析的修改内容
    强制继续:
      - 继续微调模式
      - 在CHANGELOG中标注"超范围微调"
    取消:
      - 回滚已做的修改（如有）
      - 按 G7 状态重置协议执行

"全授权模式"处理:
  - 保持 WORKFLOW_MODE = AUTO_FULL（升级后继续静默执行）
  - 设置 CURRENT_STAGE = ANALYZE
  - 自动进入轻量迭代流程
  - 在最终总结中标注升级原因

"规划模式"处理:
  - 注意: ~plan命令在evaluate.md阶段会将微调升级为轻量迭代，不会进入tweak.md
  - 如果意外进入: 保持 WORKFLOW_MODE = AUTO_PLAN，升级为轻量迭代
```

---

## 用户选择处理

> 本章节定义微调模式需要用户确认的场景，供 G3 输出格式统一提取。

### 场景: 升级判定确认

```yaml
内容要素:
  - 升级原因: 触发升级的具体原因（超出文件数/行数/跨模块/EHRB）
  - 当前修改: 已完成的修改内容摘要
  - 升级说明: 升级后将进入轻量迭代流程

选项:
  升级: 保存当前修改，进入轻量迭代流程
  强制继续: 继续微调模式，在CHANGELOG中标注"超范围微调"
  取消: 回滚已做的修改，按 G7 状态重置协议执行
```

### 场景: 微调后验收完成

```yaml
内容要素:
  - 验收状态: 通过/部分通过
  - 变更摘要: 修改的文件和行数
  - 验证结果: 基础功能验证结果（如适用）
  - 问题汇总: 警告信息（如有）

输出格式: 按 G3 场景内容规则（完成）输出
```
