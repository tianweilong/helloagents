# ~rollback 命令 - 智能回滚

本模块定义回滚操作的执行规则。


## 目录
- 命令说明
- 执行模式适配
- 执行流程
- 安全约束
- 不确定性处理
- 用户选择处理

---

## 命令说明

```yaml
命令: ~rollback
类型: 目标选择类
功能: 智能回滚变更，必须选择回滚目标（版本/提交），触发 EHRB 时按 G2 处理流程执行
```

---

## 执行模式适配

> 📌 规则引用: 按 G4 路由架构及 G5 执行模式规则执行

<mode_adaptation>
~rollback 模式适配规则:
1. 本命令为独立工具命令，不受 WORKFLOW_MODE 影响
2. 回滚前必须创建备份
3. EHRB 检测始终生效
4. 必须用户确认回滚目标
</mode_adaptation>

---

## 执行流程

### 步骤1: 检测回滚来源

<rollback_source_analysis>
回滚来源分析推理过程:
1. 检测项目是否使用Git且有提交历史
2. 检查archive/中是否存在可回滚的方案包
3. 分析CHANGELOG.md中的版本历史记录
4. 确定最佳回滚来源（优先Git，备选方案包/CHANGELOG）
</rollback_source_analysis>

```yaml
前置条件（满足任一）:
  - 项目使用 Git 且有提交历史
  - archive/ 中存在可回滚的方案包
  - CHANGELOG.md 记录了版本历史

执行内容:
  - 优先使用 Git 历史
  - 备选: 方案包历史、CHANGELOG
```

### 步骤2: 列出可回滚版本

```yaml
执行内容:
  - 最多显示5个版本
  - 显示变更摘要和文件数
```

### 步骤3: 用户选择版本

<rollback_impact_assessment>
回滚影响评估推理过程:
1. 分析目标版本与当前版本的差异
2. 识别将被覆盖的文件和变更
3. 评估回滚对依赖模块的影响
4. 按 G2 EHRB 检测规则判定是否涉及高风险操作
</rollback_impact_assessment>

```yaml
执行内容:
  - 警告回滚影响
  - 等待用户确认

按 G3 场景内容规则（确认）输出，见"用户选择处理 - 回滚版本选择"
```

### 步骤4: 创建备份

```yaml
Git仓库: 创建备份分支
非Git: 复制文件到 backup/
```

### 步骤5: 执行回滚

```yaml
执行内容:
  - 恢复代码文件
  - 验证恢复结果
```

### 步骤6: 同步知识库

```yaml
读取 KB_CREATE_MODE:

CHANGELOG更新:
  - 添加回滚记录（按 references/services/knowledge.md CHANGELOG更新规则执行）
  - 记录格式:
      ### 回滚
      - **[{模块名}]**: 回滚至 {版本/提交}
        - 原因: {回滚原因}
        - 方案: [{原方案包}](archive/{YYYY-MM}/{原方案包}/)
  - 目录/文件创建: 按 G1 "目录/文件自动创建规则" 执行

其他KB操作: 按 G1 "KB开关检查规则" 执行
  - 说明: 回滚操作始终视为编程任务，KB_CREATE_MODE=2 时按编程任务处理
```

### 步骤7: 回滚后验收

```yaml
执行规则: 按 G9 命令级验收标准（~rollback）执行

验收项:
  - 代码状态与目标版本一致 (阻断性): git status 无意外变更
  - 目标提交正确 (阻断性): git log 确认当前提交为目标版本
  - 知识库状态一致 (警告性，如适用): CHANGELOG 已更新

验收方式:
  - 执行 git status 确认无意外变更
  - 执行 git log -1 确认当前提交正确

验收失败处理:
  阻断性失败:
    - 按 G3 场景内容规则（警告）输出
    - 提示用户检查备份并手动恢复
  警告性失败:
    - 记录到回滚报告
    - 继续完成流程

完成后: 按 G3 场景内容规则（完成）输出回滚结果（含验收报告）
执行: 按 G7 状态重置协议执行
```

---

## 安全约束

> 📌 规则引用: 按 G2 EHRB 检测规则执行

```yaml
强制约束:
  - 回滚前必须创建备份
  - EHRB 检测: 按 G2 EHRB 检测规则执行（生产环境、破坏性操作、不可逆操作等）
  - EHRB 处理: 按 G2 EHRB 处理流程执行
```

---

## 不确定性处理

- 无Git历史 → 使用方案包历史
- 全部不可用 → 输出错误，建议手动处理
- 回滚冲突 → 列出冲突文件，询问用户决定

---

## 用户选择处理

> 本章节定义 ~rollback 命令需要用户确认的场景，供 G3 输出格式统一提取。

### 场景: 回滚版本选择

```yaml
内容要素:
  - 可回滚版本: 版本列表（最多5个），包含变更摘要和文件数
  - 回滚来源: 当前使用的回滚来源（Git/方案包/CHANGELOG）
  - 当前状态: 当前版本信息

选项:
  选择版本N: 选择对应序号的版本进行回滚
  取消: 按 G7 状态重置协议执行
```

### 场景: 回滚确认（EHRB警告）

> 当 G2 EHRB 检测规则触发时显示此场景

```yaml
内容要素:
  - 目标版本: 将回滚到的版本信息
  - 影响范围: 将被覆盖的文件列表和变更内容
  - 风险说明: 按 G3 场景内容规则（警告）格式（风险类型、影响范围、风险等级、检测依据）
  - 备份策略: 将创建的备份方式（分支/文件复制）

选项:
  确认回滚: 创建备份并执行回滚（按 G2 记录到 CHANGELOG）
  取消: 按 G7 状态重置协议执行
```

### 场景: 回滚冲突处理

```yaml
内容要素:
  - 冲突文件: 发生冲突的文件列表
  - 冲突详情: 每个文件的冲突内容摘要
  - 处理建议: 推荐的冲突解决方式

选项:
  覆盖本地: 使用目标版本覆盖当前文件
  保留本地: 保留当前文件，跳过冲突项
  手动处理: 暂停回滚，用户手动解决冲突
  取消: 中止回滚，按 G7 状态重置协议执行
```
