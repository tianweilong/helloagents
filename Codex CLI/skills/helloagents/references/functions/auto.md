# ~auto 命令 - 全授权命令

本模块定义全授权命令的执行规则。


## 目录
- 命令说明
- 执行模式适配
- 执行流程
- 安全约束
- 不确定性处理
- 用户选择处理

---

## 命令说明

```yaml
命令: ~auto [<需求描述>]
类型: 需求评估类
功能: 全授权命令，从需求评估到开发实施，评估需求完整性后进入对应执行模式
模式: WORKFLOW_MODE = AUTO_FULL
```

---

## 执行模式适配

> 规则引用: 按 G4 路由架构及 G5 执行模式规则执行

<mode_adaptation>
~auto 模式适配规则:
1. 本命令固定使用 AUTO_FULL 模式
2. 静默模式下自动处理所有决策点
3. 交互模式下每阶段需用户确认
4. EHRB 检测始终生效，不受模式影响
</mode_adaptation>

---

## 执行流程

### 步骤1: 设置状态变量

```yaml
执行内容:
  - WORKFLOW_MODE = AUTO_FULL
```

### 步骤2: 需求评估与触发响应

<module_loading>
本步骤的评估规则定义在 [references/stages/evaluate.md](../stages/evaluate.md) 中，
包含评分维度、追问循环规则、复杂度判定逻辑等具体指导。
</module_loading>

<requirement_analysis>
需求评估要点:
1. 解析用户需求描述的完整性
2. 按 evaluate.md 规则进行评分
3. 执行追问循环直至需求明确
4. 判定复杂度等级（微调/轻量迭代/标准开发）
</requirement_analysis>

```yaml
执行规则: 读取并执行 references/stages/evaluate.md（评分、追问循环、复杂度判定）

输出: 按 G3 场景内容规则（确认）输出，见"用户选择处理 - 执行模式确认"

[等待用户响应]

用户选择后按对应选项处理
```

### 步骤3: 执行对应模式

<mode_routing_analysis>
模式路由要点:
1. 根据复杂度判定结果选择执行路径
2. 微调模式直接进入 tweak.md 流程
3. 轻量迭代/标准开发继续后续步骤
</mode_routing_analysis>

```yaml
根据复杂度判定结果:
  微调模式: 读取并执行 references/stages/tweak.md
  轻量迭代/标准开发: 进入步骤4
```

### 步骤4: 项目分析（仅轻量迭代/标准开发）

```yaml
执行规则: 读取并执行 references/stages/analyze.md

静默模式: 不输出
交互模式: 输出阶段完成提示
```

### 步骤5: 方案设计

```yaml
执行规则: 读取并执行 references/stages/design.md

复杂任务: 静默模式下自动选择推荐方案
简单任务: 静默模式下自动确定方案
overview 类型: 归档至 archive/，跳过开发实施

设置: CREATED_PACKAGE = 本次创建的方案包路径
```

### 步骤6: 开发实施

```yaml
执行规则: 读取并执行 references/stages/develop.md

静默模式: 执行所有任务，质量问题在总结中列出
交互模式: 每个任务完成后提示
```

### 步骤7: 流程级验收

```yaml
执行规则: 按 G9 "流程级验收规则" 执行（验收内容详见 G9）

遗留方案包扫描:
  执行规则: 按 G7 "遗留方案包扫描" 执行
  扫描时机: 流程即将结束时
  显示条件: 检测到≥1个遗留方案包
  详细规则: 参考 references/rules/package.md "遗留方案包处理"

完成后: 按 G3 场景内容规则（完成）输出全授权命令结果（含验收报告）
执行: 按 G7 状态重置协议执行
```

---

## 安全约束

> 规则引用: 按 G2 EHRB 检测规则执行

```yaml
强制约束:
  - EHRB 检测始终生效，检测到时必须打破静默
  - 阻断性测试失败必须中断静默模式
  - 方案包验收失败（阻断性）必须用户确认
```

### 打破静默规则

```yaml
适用时机: 用户选择确认执行后进入静默模式期间

必须打破静默的情况:
  - 检测到 EHRB（极度高风险行为）
  - 阻断性测试失败
  - 方案包验收失败（阻断性）
  - 无法自动解决的错误

用户响应后:
  - 有效输入: 恢复静默，继续执行
  - "取消": 按 G7 状态重置协议执行
```

---

## 不确定性处理

- 需求描述不完整 → 按 evaluate.md 追问循环处理
- 复杂度难以判定 → 默认使用轻量迭代模式
- 方案选择冲突 → 静默模式下选择推荐方案
- 测试失败但非阻断性 → 记录到验收报告，继续执行

---

## 用户选择处理

> 本章节定义 ~auto 命令需要用户确认的场景，供 G3 输出格式统一提取。

### 场景: 执行模式确认（需求评估完成后）

```yaml
触发条件: WORKFLOW_MODE = AUTO_FULL（~auto命令触发）

内容要素:
  - 需求评估结果摘要
  - 复杂度判定结果（微调/轻量迭代/标准开发）
  - 执行方式说明（静默执行 vs 交互执行的区别）
  - 预计影响范围

选项:
  确认执行（静默）: 保持 WORKFLOW_MODE = AUTO_FULL，静默执行直到流程完成
  交互执行: 设置 WORKFLOW_MODE = INTERACTIVE，切换为交互模式，每阶段确认
  调整模式: 允许用户选择其他执行模式（微调/轻量迭代/标准开发）
  取消: 按 G7 状态重置协议执行

状态变更规则:
  - "确认执行": 保持 AUTO_FULL 不变
  - "交互执行": WORKFLOW_MODE → INTERACTIVE（模式切换，详见 references/rules/state.md）
```

### 场景: 打破静默确认

```yaml
内容要素:
  - 打破静默原因（EHRB/测试失败/方案包验收失败/无法解决的错误）
  - 问题详情描述
  - 建议的处理方式

选项:
  继续执行: 恢复静默，继续执行
  手动处理: 暂停静默，用户介入处理
  取消: 按 G7 状态重置协议执行
```

### 场景: 流程级验收完成

```yaml
内容要素:
  - 验收状态: 通过/部分通过/失败
  - 交付物摘要: 方案包、代码变更、知识库状态
  - 需求符合性: 已完成项/未完成项
  - 问题汇总: 警告和信息性记录（如有）

输出格式: 按 G3 场景内容规则（完成）输出
```
