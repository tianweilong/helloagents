# ~clean 命令 - 清理遗留方案

本模块定义清理遗留方案包的执行规则。


## 目录
- 命令说明
- 执行模式适配
- 执行流程
- 不确定性处理
- 用户选择处理

---

## 命令说明

```yaml
命令: ~clean
类型: 场景确认类
功能: 清理 plan/ 目录中的遗留方案包，列出方案包让用户选择清理范围
```

---

## 执行模式适配

> 规则引用: 按 G4 路由架构及 G5 执行模式规则执行

<mode_adaptation>
~clean 模式适配规则:
1. 本命令为独立工具命令，不受 WORKFLOW_MODE 影响
2. 清理操作需用户确认范围（全部/选择性）
3. 方案包迁移至 archive/ 而非直接删除
4. 迁移时标记状态为 skipped
</mode_adaptation>

---

## 执行流程

> 规则引用: 脚本路径、存在性检查、错误恢复规则见 [references/rules/tools.md](../rules/tools.md)
> 规则引用: 目录/文件创建按 G1 "目录/文件自动创建规则" 执行

### 步骤1: 列出方案包

<package_scan_analysis>
方案包扫描要点:
1. 检查 plan/ 目录是否存在
2. 扫描目录内的方案包
3. 提取方案包信息（名称、创建时间、类型）
</package_scan_analysis>

```yaml
前置条件: plan/ 目录存在至少一个方案包

脚本调用: list_packages.py
用途: 获取 plan/ 目录中的方案包列表

无方案包时: 按 G3 场景内容规则（完成）输出提示，流程结束
```

### 步骤2: 用户确认

```yaml
展示内容: 方案包列表（名称、创建时间、类型）
询问选项: 全部清理 / 选择性清理 / 取消

按 G3 场景内容规则（确认）输出
```

### 步骤3: 执行迁移

<package_migration_analysis>
方案包迁移要点:
1. 根据用户选择确定迁移范围
2. 调用迁移脚本执行操作
3. 验证迁移结果
</package_migration_analysis>

```yaml
脚本调用: migrate_package.py <package-name> --status skipped
参数:
  package-name: 方案包名称（或使用 --all 迁移全部）
  --status skipped: 标记为未执行

执行内容: 将选中的方案包迁移至 archive/
```

**脚本执行报告处理:**

<script_report_handling>
脚本执行报告处理流程:
1. 解析脚本输出的 JSON 执行报告
2. success=true 时继续后续步骤
3. success=false 时按 tools.md "AI降级接手流程" 执行
4. 质量检查 completed 步骤后再继续
</script_report_handling>

```yaml
解析 migrate_package.py 输出:
  success=true:
    - 迁移完成，继续步骤4验收

  success=false:
    - 执行: 按 references/rules/tools.md "脚本执行报告机制 - AI降级接手流程" 处理
    - 步骤1: 质量检查 completed 列表中已完成的步骤
      - 验证方案包存在: 确认源路径
      - 创建归档目录: 确认 archive/YYYY-MM/ 存在
      - 更新 tasks.md 状态: 检查 @status 行
      - 移动方案包: 确认目标路径存在且源已删除
      - 更新 _index.md: 检查索引记录
    - 步骤2: 发现问题则修复
    - 步骤3: 按 pending 列表继续完成（参考 templates.md "AI接手时的文件创建指南"）
```

### 步骤4: 清理后验收

```yaml
执行规则: 按 G9 命令级验收标准（~clean）执行

验收项:
  - 目标方案包已迁移 (信息性): 确认方案包已从 plan/ 移至 archive/
  - 无误删重要文件 (警告性): 确认只迁移了用户选择的方案包

验收方式:
  - 列出已迁移的方案包清单
  - 确认 plan/ 目录状态

验收失败处理:
  警告性失败:
    - 记录到清理报告
    - 提示用户检查 archive/ 目录

完成后: 按 G3 场景内容规则（完成）输出清理结果（含验收报告）
执行: 按 G7 状态重置协议执行
```

---

## 不确定性处理

- plan/ 目录不存在 → 按 [G3 场景内容规则](../rules/output.md)（完成）输出，提示无需清理
- 方案包迁移失败 → 报告失败项，继续处理其他方案包
- archive/ 目录不存在 → 自动创建后继续

---

## 用户选择处理

> 本章节定义 ~clean 命令需要用户确认的场景，供 G3 输出格式统一提取。

### 场景: 遗留方案包清理确认

```yaml
内容要素:
  - 遗留方案包列表: plan/ 目录下的方案包清单（名称、创建时间、类型）
  - 方案包摘要: 每个方案包的简要描述

选项:
  全部清理: 迁移所有遗留方案包至 archive/
  选择性清理: 列出方案包让用户选择
  取消: 按 G7 状态重置协议执行
```

### 场景: 清理后验收完成

```yaml
内容要素:
  - 验收状态: 通过/部分通过
  - 已迁移方案包: 方案包清单（名称、迁移路径）
  - plan/ 目录状态: 剩余方案包数量（如有）
  - 问题汇总: 警告信息（如有）

输出格式: 按 G3 场景内容规则（完成）输出
```
