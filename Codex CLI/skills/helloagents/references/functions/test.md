# ~test 命令 - 运行测试

本模块定义运行测试的执行规则。


## 目录
- 命令说明
- 执行模式适配
- 执行流程
- 不确定性处理
- 用户选择处理

---

## 命令说明

```yaml
命令: ~test
类型: 场景确认类
功能: 检测框架运行测试并分析结果，特定场景需确认（多框架/无法检测）
```

---

## 执行模式适配

> 📌 规则引用: 按 G4 路由架构及 G5 执行模式规则执行

<mode_adaptation>
~test 模式适配规则:
1. 本命令为独立工具命令，不受 WORKFLOW_MODE 影响
2. 自动检测测试框架，多框架时需用户选择
3. 无法检测时请求用户提供测试命令
4. 测试失败时提供修复方案选项
</mode_adaptation>

---

## 执行流程

### 步骤1: 发现测试框架

<test_framework_detection>
测试框架识别推理过程:
1. 扫描项目配置文件（package.json, pyproject.toml等）
2. 识别测试框架特征（jest, pytest, mocha等）
3. 定位测试目录和文件模式
4. 多框架共存时分析主要测试框架
5. 无法检测时请求用户提供测试命令
</test_framework_detection>

```yaml
执行内容:
  - 扫描项目配置文件识别测试框架
  - 多框架共存时询问用户选择
  - 无法检测时请求用户提供测试命令
```

### 步骤2: 发现测试文件

```yaml
执行内容:
  - 扫描常见测试目录和文件
  - 匹配测试文件命名模式
```

### 步骤3: 运行测试

```yaml
执行内容:
  - 执行测试命令（带超时保护）
  - 捕获输出和退出码
```

### 步骤4: 分析结果

<test_result_analysis>
测试结果分析推理过程:
1. 解析测试输出获取通过/失败/跳过统计
2. 提取失败测试的文件路径和行号
3. 分析错误信息确定失败原因
4. 判断是否为阻断性测试失败
5. 生成修复建议
</test_result_analysis>

```yaml
执行内容:
  - 解析通过/失败/跳过统计
  - 提取失败测试的文件路径和行号
  - 提取错误摘要
```

### 步骤5: 输出报告与后续操作

```yaml
输出: 按 Shell 包装规则输出结果

有失败时:
  按 G3 场景内容规则（确认）输出，见"用户选择处理 - 测试失败处理"
  [等待用户响应]
  用户选择后按对应选项处理

目录/文件创建: 按 G1 "目录/文件自动创建规则" 执行

完成后: 按 G7 状态重置协议执行
```

---

## 不确定性处理

- 无法检测框架 → 询问用户提供测试命令
- 多框架共存 → 列出选项请用户选择
- 测试超时 → 询问是否延长或终止
- 输出无法解析 → 返回原始输出，建议手动分析

---

## 用户选择处理

> 本章节定义 ~test 命令需要用户确认的场景，供 G3 输出格式统一提取。

### 场景: 测试框架选择（多框架共存时）

```yaml
内容要素:
  - 检测到的框架列表
  - 各框架的测试文件数量和位置
  - 推荐选择（根据项目主要框架）

选项:
  选择框架N: 使用对应序号的框架运行测试
  全部运行: 依次运行所有框架的测试
  取消: 按 G7 状态重置协议执行
```

### 场景: 无法检测框架

```yaml
内容要素:
  - 检测结果: 无法自动识别测试框架
  - 请求用户提供测试命令

选项:
  用户输入测试命令: 使用用户提供的命令运行测试
  取消: 按 G7 状态重置协议执行
```

### 场景: 测试失败处理

```yaml
内容要素:
  - 测试结果摘要（通过/失败/跳过统计）
  - 失败测试列表（文件路径、行号、错误摘要）
  - 修复建议

选项:
  生成修复方案: 创建 plan/YYYYMMDDHHMM_fix-tests/ 方案包
  仅记录报告: 输出完整报告
  跳过: 不执行操作
```
