# ~plan 命令 - 执行到方案设计

本模块定义规划命令的执行规则。


## 目录
- 命令说明
- 执行模式适配
- 执行流程
- 微调模式处理
- 不确定性处理
- 用户选择处理

---

## 命令说明

```yaml
命令: ~plan [<需求描述>]
类型: 需求评估类
功能: 执行到方案设计阶段后停止（不进入开发实施），评估需求完整性后进入方案设计
模式: WORKFLOW_MODE = AUTO_PLAN
```

---

## 快速路径（CRITICAL，e2e/单回合友好）

**适用条件：**
- 用户输入为 `~plan <需求描述>`（非空）
- 未命中 EHRB（见 G2）

**目标：** 在单回合内完成“创建 implementation 方案包 + 填充 proposal/tasks + validate + 给出可复制的验证/执行命令”。  
**约束：** 为避免超时，满足以上条件时 **不要展开/读取** `evaluate.md`/`analyze.md`/`design.md` 全文；本文件已给出最小可执行流程。

**执行步骤（必须按序）：**
1. 设置状态：`WORKFLOW_MODE=AUTO_PLAN`、`STAGE_ENTRY_MODE=NATURAL`
2. 规范化需求（仅内部）：提炼目标/范围/约束；不输出长篇评分
3. 直接创建方案包（必须用脚本，不要手写目录）：
   - `python3 -X utf8 "{SKILL_ROOT}/scripts/create_package.py" "<feature>" --type implementation --path .`
4. 填充方案包：
   - 优先使用预置模板（避免长文本手写导致超时/卡死）：
     - 例如本用例可直接复制：`{SKILL_ROOT}/assets/presets/evals-lint-no-bare-references/{proposal.md,tasks.md}`
   - 若无预置模板：
     - `proposal.md`：只填“需求/目标/约束/验收标准/方案/影响范围/风险”，其余章节可删除或留空但不得保留花括号占位符
     - `tasks.md`：4-8 条可执行任务，每条都要有“验证命令/检查点”，且拆分粒度可验证
5. 验证方案包（必须用脚本）：
   - `python3 -X utf8 "{SKILL_ROOT}/scripts/validate_package.py" --path . "<package-name>"`
6. 输出（按 G3 完成场景）必须包含：
   - 方案包路径
   - 任务清单摘要：列出 tasks.md 的关键任务（≥4 条），每条至少包含“做什么 + 如何验证”
   - 如何验证（给出可复制命令）
   - 如何执行（例如 `~exec <package-name>` 或后续实施建议）

---

## 执行模式适配

> 📌 规则引用: 按 G4 路由架构及 G5 执行模式规则执行

<mode_adaptation>
~plan 模式适配规则:
1. 本命令固定使用 AUTO_PLAN 模式
2. 流程在方案设计完成后终止，不进入开发实施
3. 微调模式需特殊处理（建议直接执行或强制规划）
4. 静默模式下自动选择推荐方案
</mode_adaptation>

---

## 执行流程

### 步骤1: 设置状态变量

```yaml
执行内容:
  - WORKFLOW_MODE = AUTO_PLAN
  - STAGE_ENTRY_MODE = NATURAL
```

### 步骤2: 需求评估与触发响应

<module_loading>
本步骤的评估规则定义在 [references/stages/evaluate.md](../stages/evaluate.md) 中，
包含评分维度、追问循环规则、复杂度判定逻辑等具体指导。

注意（快速路径）：
- 当用户提供了明确的 `~plan <需求描述>` 且未命中 EHRB 时，优先走本文件的“快速路径”，**不要展开/读取 evaluate.md 全文**（缺失点写入方案包的假设/待确认）。
</module_loading>

<requirement_analysis>
需求评估推理过程:
1. 解析用户需求描述的完整性
2. 按 evaluate.md 规则进行评分
3. 处理缺失点：
   - 用户未提供需求描述 → 执行追问循环并等待用户补充
   - 用户提供需求描述 → 不在评估阶段阻塞；将追问点下沉为“假设/待确认”写入方案包
4. 判定复杂度等级（微调/轻量迭代/标准开发）
</requirement_analysis>

```yaml
输入分支:
  用户未提供需求描述（例如仅输入 `~plan`）:
    执行: 不读取任何文件/不运行任何命令；直接输出追问（≤5）+ 风险说明，并等待用户补充
    输出: 按 G3 场景内容规则（追问）输出并等待用户补充

  用户提供需求描述（`~plan <需求描述>`）:
    约束: 不在需求评估阶段卡追问/确认（除非命中 EHRB）
    默认: 走本文件顶部“快速路径”（创建 implementation 方案包 → 填充 → validate → 输出），不再展开 analyze/design 大模块
    行为: 将缺失点写入方案包的“假设/待确认”
    禁止: 输出“待确认执行方式/请选择执行方式”并等待用户（~plan 应继续直到创建方案包并输出结果）

EHRB:
  命中 EHRB: 必须按 G2 输出确认并等待用户同意后再继续
```

### 步骤3: 执行对应模式

<mode_routing_analysis>
模式路由推理过程:
1. 根据复杂度判定结果选择执行路径
2. 微调模式需特殊处理（建议直接执行）
3. 轻量迭代/标准开发继续后续步骤
</mode_routing_analysis>

```yaml
根据复杂度判定结果:
  微调模式: 默认强制规划（升级为轻量迭代）以生成方案包，进入步骤4
  轻量迭代/标准开发: 进入步骤4
```

### 步骤4: 项目分析（仅轻量迭代/标准开发）

```yaml
执行规则: 读取并执行 references/stages/analyze.md

静默模式: 不输出
交互模式: 输出阶段完成提示
```

### 步骤5: 方案设计

```yaml
执行规则: 读取并执行 references/stages/design.md

复杂任务: 静默模式下自动选择推荐方案
简单任务: 静默模式下自动确定方案

设置: CREATED_PACKAGE = 本次创建的方案包路径
```

### 步骤6: 流程级验收

```yaml
执行规则: 按 G9 "流程级验收规则" 执行

验收内容:
  交付物验收:
    - 方案包状态: 已创建
    - 方案包验收: 通过/部分通过

  需求符合性:
    - 原始需求回顾
    - 方案覆盖范围

  问题汇总:
    - 方案包验收警告（如有）
    - 信息性记录

遗留方案包扫描:
  执行规则: 按 G7 "遗留方案包扫描" 执行
  扫描时机: 流程即将结束时
  显示条件: 检测到≥1个遗留方案包
  详细规则: 参考 references/rules/package.md "遗留方案包处理"

完成后: 按 G3 场景内容规则（完成）输出规划命令结果（含验收报告）
输出要求（必须包含）:
  - 方案包路径: ${CREATED_PACKAGE}
  - 任务清单摘要: 列出 tasks.md 的关键任务（≥4 条），每条含“做什么 + 如何验证”
  - 如何验证: 给出可复制的命令（例如 validate_package.py 或 ~validate）
  - 如何执行: 给出可复制的命令（例如 ~exec <package-name>）
执行: 按 G7 状态重置协议执行
流程终止（不进入开发实施）
```

---

## 微调模式处理

```yaml
触发条件: 复杂度判定为微调模式时

执行规则:
  ~plan 的目标是生成方案包，因此在 AUTO_PLAN 下默认执行“强制规划”：
    - 设置: CURRENT_STAGE = ANALYZE
    - 执行: references/stages/analyze.md → design.md → plan.md 步骤6

  例外:
    - 用户明确要求“不创建方案包/只要文字建议”时，才降级为仅输出文字规划并结束
```

---

## 不确定性处理

- 需求描述不完整 → 按 evaluate.md 追问循环处理
- 复杂度判定为微调 → 默认强制规划生成方案包（~plan 的核心目标）
- 方案设计无法完成 → 输出已完成部分，标注待定项

---

## 用户选择处理

> 本章节定义 ~plan 命令需要用户确认的场景，供 G3 输出格式统一提取。

### 场景: 执行模式确认（需求评估完成后）

```yaml
触发条件:
  - WORKFLOW_MODE = AUTO_PLAN（~plan命令触发）
  - 且出现需要“卡点确认”的情况（例如命中 EHRB 或用户明确要求暂停/交互确认）

内容要素:
  - 需求评估结果摘要
  - 复杂度判定结果（微调/轻量迭代/标准开发）
  - 预计影响范围

选项:
  确认继续: 继续执行直到方案设计完成
  取消: 按 G7 状态重置协议执行

注意: 默认不应触发该场景；未命中 EHRB 时应直接进入后续步骤（不等待用户）
```

### 场景: 微调模式处理

```yaml
触发条件: ~plan命令 + 复杂度判定为微调模式

内容要素:
  - 复杂度判定: 微调模式
  - 模式说明: 微调模式无需方案设计，~plan命令的目标是生成方案包
  - 操作选项说明

选项:
  默认（AUTO_PLAN）:
    - 行为: 自动选择“强制规划”，生成方案包并输出可执行 tasks.md
  如用户想直接执行:
    - 建议: 改用 ~auto 或普通对话进入微调模式执行
  取消: 按 G7 状态重置协议执行

注意: ~plan命令的微调模式是特殊情况，因为微调不产生方案包
```

### 场景: 流程级验收完成

```yaml
内容要素:
  - 验收状态: 通过/部分通过/失败
  - 交付物摘要: 方案包路径和状态
  - 需求符合性: 方案覆盖范围
  - 问题汇总: 警告和信息性记录（如有）

输出格式: 按 G3 场景内容规则（完成）输出
```
