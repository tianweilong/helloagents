# ~init 命令 - 初始化知识库

本模块定义知识库初始化的执行规则。


## 目录
- 命令说明
- 执行模式适配
- 执行流程
- 不确定性处理
- 用户选择处理

---

## 命令说明

```yaml
命令: ~init
类型: 场景确认类
功能: 扫描代码库创建知识库，根据检测场景展示确认选项
```

---

## 关键输出要求（CRITICAL）

- 输出中必须明确：
  - 当前 `KB_CREATE_MODE` 值
  - 本次是否 `KB_SKIPPED`（当 `KB_CREATE_MODE=0` 且不忽略开关时为 true，否则为 false）
  - `helloagents/` 是否存在，以及本次是否会写入/是否已跳过（不要只用“权限/只读”代替开关语义）
  - 开关语义一句话：`KB_CREATE_MODE=0` 时默认不写入（`KB_SKIPPED=true`，并明确“知识库已跳过”）
  - 确认点一句话：如检测到知识库已存在或结构不匹配，必须先确认“升级/重建/取消”，不会静默覆盖/重建
  - 模板来源一句话：本次创建/补全使用 `{TEMPLATE_DIR}/`（templates 服务）写入，默认不覆盖已存在文件

**硬性要求：以上两句“语义说明”必须出现在输出中（即使当前 `KB_CREATE_MODE!=0`、即使当前未触发结构不匹配分支）。**

```text
（必须出现的两行文案示例，可等价改写但含义必须完整）
- 开关语义：KB_CREATE_MODE=0 时默认 KB_SKIPPED=true（知识库已跳过，不写入）
- 确认点语义：如 helloagents/ 已存在或结构不匹配，会先确认升级/重建/取消，不会静默覆盖
- 模板来源：从 {TEMPLATE_DIR}/ 写入（默认不覆盖）
```

## 执行模式适配

> 规则引用: 按 G4 路由架构及 G5 执行模式规则执行

<mode_adaptation>
~init 模式适配规则:
1. 本命令为独立工具命令，不受 WORKFLOW_MODE 影响
2. KB_CREATE_MODE=0 时需用户确认后执行
3. 知识库已存在时需用户确认重建或升级
4. 大型项目自动启用分批处理
</mode_adaptation>

---

## 执行流程

### 步骤1: 知识库开关检查

<kb_switch_analysis>
知识库开关检查要点:
1. 读取 KB_CREATE_MODE 当前值
2. 若为 0 (OFF)，提示用户确认是否继续
3. 若为 1/2/3，直接继续执行
</kb_switch_analysis>

```yaml
执行时机: 进入init流程后首先检查

IF KB_CREATE_MODE = 0 (OFF):
  设置: KB_SKIPPED = true
  按 G3 场景内容规则（确认）输出（默认跳过写入，并明确“知识库已跳过”）

  用户选择处理:
    继续执行: 忽略开关（KB_SKIPPED=false），继续执行下方流程
    取消: 按 G7 状态重置协议执行，流程终止

ELSE (开关=1/2/3):
  设置: KB_SKIPPED = false
  直接继续执行下方流程（无需额外确认）
```

### 步骤2: 检测现有知识库状态

<kb_status_analysis>
知识库状态检测要点:
1. 检查 helloagents/ 目录是否存在
2. 检查核心文件完整性
3. 对比当前结构与框架标准
4. 判定处理路径（全新创建/升级/补全/重建）
</kb_status_analysis>

```yaml
工具使用:
  - 脚本: upgradewiki.py --scan（优先；用于判断是否存在/结构信息）
  - 文件查找: 检查 helloagents/ 目录是否存在（兜底）
  - 文件读取: 检查知识库核心文件（核心文件定义见 references/services/knowledge.md）

状态判定:
  不存在: 全新创建
  存在但结构与当前框架不匹配: 建议升级
  存在但不完整: 补全缺失文件
  存在且完整: 询问是否重建
```

**检测到结构不匹配时：** 按 [G3 场景内容规则](../rules/output.md)（确认）输出

```yaml
用户选择处理:
  升级: 转发到 references/functions/upgrade.md
  重建: 继续执行步骤3-5
  取消: 按 G7 状态重置协议执行
```

**重建确认（知识库已存在且完整时）：** 按 [G3 场景内容规则](../rules/output.md)（确认）输出

### 步骤3: 扫描代码库

<techstack_detection>
技术栈识别要点:
1. 扫描根目录配置文件（package.json, pyproject.toml, pom.xml等）
2. 分析源代码文件扩展名分布
3. 检查框架特征文件（如 next.config.js, vite.config.ts）
4. 综合判断主要语言、框架、包管理器
5. 如无法确定，标注"未识别"并建议用户补充
</techstack_detection>

```yaml
工具使用:
  - 文件查找: 扫描项目源代码目录结构
  - 文件读取: 读取关键配置文件
  - 内容搜索: 识别模块、API、数据模型

技术栈识别策略（语言无关）:
  识别顺序:
    1. 扫描根目录的包管理/构建配置文件
    2. 分析源代码文件扩展名分布
    3. 检查常见框架特征文件
  识别优先级:
    1. 根目录配置文件（最可靠）
    2. 常见子目录（src/、lib/、app/）
    3. 文件扩展名统计（兜底）
  输出要求:
    - 记录到 context.md 的"技术上下文"章节
    - 包含: 语言、框架、包管理器、构建工具
    - 如无法确定，标注"未识别"并建议用户补充

提取信息:
  - 技术栈（语言、框架、依赖）
  - 模块结构（目录分析）
  - API接口（路由文件扫描）
  - 数据模型（模型文件扫描）
```

### 步骤4: 创建知识库文件

**执行顺序（CRITICAL）**
1. 先直接运行脚本 `init_kb.py` 完成落盘（不要先读脚本源码）。
2. 成功后再运行 `upgradewiki.py --scan` 或 `~validate` 做结构校验，并在输出里汇总“创建了哪些目录/文件”。
3. 只有当脚本实际执行失败且错误明确指向“权限不足/只读/沙盒阻止”时，才提示用户在本机终端手动执行，并在输出中说明：`KB_CREATE_MODE`/`KB_SKIPPED` 语义正常，但由于环境限制未能写入。

```yaml
目录创建规则: 按 G1 "目录/文件自动创建规则" 执行

优先脚本入口（推荐）:
  - init_kb.py --path <项目根目录>
    - 行为: 创建 helloagents/ 目录结构，并从 assets/templates/ 写入最小可用的基础文件
    - 安全: 默认不覆盖已存在文件（避免静默覆盖/重建）
    - 约束（CRITICAL）: 在可写沙盒（workspace-write/danger-full-access）下应**直接执行脚本**完成落盘；仅当脚本执行被沙盒阻止或实际失败时，才改为提示用户在本机终端手动执行
    - 约束（CRITICAL）: **不要**通过读取脚本源代码（sed/cat）来替代执行；本命令的优先证据应来自“脚本执行记录 + JSON 执行报告”

如需手工创建（仅脚本不可用时）:
  - 读取 references/services/templates.md 获取模板
  - 按模板索引逐一写入到 helloagents/（避免 cp 覆盖；先检查是否存在）

大型项目处理:
  判定条件: 按 references/rules/scaling.md 规则判定
  目录结构（模块数>30时）:
    - helloagents/modules/_index.md（全局索引）
    - helloagents/modules/core/（核心模块）
    - helloagents/modules/feature/（功能模块）
    - helloagents/modules/shared/（共享模块）
  处理方式:
    - 分批处理（每批≤20个模块）
    - 优先处理核心模块
    - 在总结中说明处理进度
```

### 步骤5: 质量验证

> 规则引用: 验收标准见 G9 "~init 验收标准"

```yaml
验证项:
  完整性:
    - 核心文件存在且非空
    - 模块覆盖完整
  安全性:
    - 无敏感信息泄露（密钥、密码等）
  格式:
    - Markdown格式正确
    - Mermaid图表可渲染

完成后: 按 G3 场景内容规则（完成）输出初始化结果
执行: 按 G7 状态重置协议执行
```

---

## 不确定性处理

- 空项目（无源代码文件） → 按 [G3 场景内容规则](../rules/output.md)（错误）输出，建议确认目录
- 权限不足（无法创建目录） → 按 [G3 场景内容规则](../rules/output.md)（错误）输出，建议检查权限
- 扫描超时（大型项目） → 分批处理，输出进度提示
- 配置文件缺失（无法识别项目类型） → 询问用户提供技术栈信息

---

## 用户选择处理

> 本章节定义 ~init 命令需要用户确认的场景，供 G3 输出格式统一提取。

### 场景: 知识库开关确认（KB_CREATE_MODE=0）

```yaml
内容要素:
  - 当前开关状态: KB_CREATE_MODE = 0 (OFF)
  - 行为说明: 知识库写入已关闭（默认 KB_SKIPPED=true，不写入）；如选择继续则会忽略开关写入

选项:
  继续执行: 忽略开关，继续初始化知识库
  取消: 按 G7 状态重置协议执行
```

### 场景: 结构不匹配

```yaml
内容要素:
  - 检测结果: 知识库存在但结构与当前框架不匹配
  - 不匹配说明: 具体的结构差异描述

选项:
  升级: 转发到 references/functions/upgrade.md
  重建: 删除现有知识库，重新创建
  取消: 按 G7 状态重置协议执行
```

### 场景: 知识库重建确认

```yaml
内容要素:
  - 已存在说明: 知识库已存在且完整
  - 重建影响: 将删除现有内容并重新创建

选项:
  重建: 删除现有知识库，重新创建
  取消: 按 G7 状态重置协议执行
```
