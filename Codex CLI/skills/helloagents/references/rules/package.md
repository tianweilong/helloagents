# 方案包生命周期规则

本模块定义方案包的创建、执行、归档等生命周期管理规则。


## 目录
- 规则概述
- 核心规则
- 异常处理
- 规则引用关系
- 用户选择处理

---

## 规则概述

> 📌 规则引用: 任务状态符号、方案包类型定义见 G7

```yaml
规则名称: 方案包生命周期规则
适用范围: 所有涉及方案包操作的命令和阶段
核心职责:
  - 定义方案包路径命名规范
  - 管理方案包创建、执行、归档流程
  - 处理 Overview 类型方案包特殊逻辑
  - 执行遗留方案包扫描和清理
```

---

<package_lifecycle>
## 核心规则

### 方案包路径

`plan/YYYYMMDDHHMM_{feature}/`

### 生命周期管理

<lifecycle_rules>
方案包生命周期规则:
1. 创建阶段: 方案设计完成后创建方案包目录和文件
2. 执行阶段: 按 tasks.md 逐任务执行，更新任务状态
3. 归档阶段: 执行完成后迁移至 archive/YYYY-MM/
4. 同名冲突: 使用版本后缀 _v2, _v3...
</lifecycle_rules>

```yaml
创建规则:
  - 同名冲突时使用版本后缀 _v2, _v3...
  - 必须包含 proposal.md 和 tasks.md

执行规则:
  - 按 tasks.md 任务顺序执行
  - 实时更新任务状态符号

归档规则:
  - 开发实施完成后强制迁移至 archive/YYYY-MM/
  - 保持目录名，同名覆盖

验证规则:
  - 验证脚本: scripts/validate_package.py
  - 验证项: 必需文件存在性、任务解析、方案类型识别
  - 任务状态符号: [ ](待执行), [√](已完成), [X](失败), [-](跳过), [?](待确认)
```

### Overview 类型方案包生命周期

> 📌 规则引用: 创建阶段规则见 G7 "方案包类型判定"

<overview_handling>
Overview类型处理推理过程:
1. 检测方案包类型（tasks.md内容分析）
2. 判断是否为概述文档（无执行任务）
3. 根据触发来源选择归档方式
4. 执行归档并更新索引
</overview_handling>

```yaml
归档方式:
  方式1 - 通过 ~exec 命令:
    - 检测到 overview 类型后询问用户
    - 用户选择"归档"后直接迁移至 archive/
    - 迁移时状态标记为 "overview"

  方式2 - 通过 ~clean 命令:
    - 手动归档遗留方案包
    - 归档时状态标记为 "overview"

  方式3 - 全授权命令（~auto）:
    - 静默归档，不执行开发实施步骤

不自动归档:
  - overview 类型方案包不会在方案设计完成后自动归档
  - 需要用户通过 ~exec 或 ~clean 手动触发归档
```

### 已执行方案包迁移（开发实施阶段强制执行）

```yaml
迁移步骤:
  1. 更新tasks.md任务状态（使用任务状态符号）
  2. 非[√]状态任务下方添加备注（格式: `> 备注: {原因}`）
  3. 迁移至 archive/YYYY-MM/（保持目录名，同名覆盖）
  4. 更新 archive/_index.md
```

### 遗留方案包扫描

<scan_rules>
遗留方案包扫描规则:
1. 在指定触发时机自动执行扫描
2. 排除当前正在执行的方案包
3. 检测到遗留包时提示用户处理
4. 扫描完成后清除CURRENT_PACKAGE变量
</scan_rules>

```yaml
触发时机:
  - 开发实施完成
  - 执行命令完成
  - 全授权命令完成
  - 方案设计完成
  - 规划命令完成
  - 轻量迭代完成

扫描规则:
  - 扫描: plan/目录下所有方案包
  - 排除: 本次执行的方案包（CURRENT_PACKAGE）
  - 清除: CURRENT_PACKAGE变量
  - 条件: 检测到≥1个遗留方案包时才输出提示
  - 输出: 按 G3 场景内容规则（确认）输出
```
</package_lifecycle>

---

## 异常处理

```yaml
方案包创建失败:
  - 检查 plan/ 目录是否存在
  - 检查命名冲突并使用版本后缀
  - 仍失败则暂停流程，提示用户处理

迁移失败:
  - 检查 archive/ 目录是否存在
  - 检查目标路径权限
  - 重试一次后仍失败则保留原位置，记录错误

索引更新失败:
  - archive/_index.md 不存在时自动创建
  - 写入失败时在完成报告中标注
```

---

## 规则引用关系

```yaml
被引用:
  - G7 方案包类型判定
  - ~exec 命令（方案包执行和归档）
  - ~clean 命令（遗留方案包清理）
  - ~auto 命令（全授权流程）
  - 开发实施阶段（方案包迁移）

引用:
  - G7 任务状态符号
  - G7 方案包类型定义
  - G7 状态重置协议
  - G3 场景内容规则
```

---

## 用户选择处理

> 本章节定义方案包生命周期中需要用户确认的场景，供 G3 输出格式统一提取。

### 场景: Overview类型方案包处理

```yaml
触发条件: ~exec 命令检测到 overview 类型方案包

内容要素:
  - 方案包类型: overview（概述文档）
  - 类型说明: 此方案包为概述文档，无需执行开发任务

选项:
  归档: 执行方案包迁移至 archive/
  查看: 显示 proposal.md 内容，再次询问
  取消: 按 G7 状态重置协议执行

特殊处理:
  方案设计阶段:
    - tasks.md 内容标注: "> 无执行任务（概述文档）"
    - 方案设计完成后不提示"进入开发实施"选项
    - 下一步选项: 调整 / 完成

  ~auto 命令检测到 overview:
    - 静默归档，在完成总结中标注"概述文档，已归档"

  归档记录格式:
    - archive/_index.md 中标注: | {方案包名称} | overview | {日期} | 概述文档 |
```

### 场景: 遗留方案包扫描

```yaml
触发条件: 阶段完成时检测到≥1个遗留方案包

内容要素:
  - 遗留方案包列表: plan/ 目录下的方案包清单（名称、创建时间、类型）
  - 当前状态: 检测到N个遗留方案包

选项:
  清理: 执行 ~clean 命令
  忽略: 继续当前操作
```
