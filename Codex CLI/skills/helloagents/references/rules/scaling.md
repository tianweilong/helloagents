# 大型项目扩展规则

本模块定义大型项目的判定标准和文档分片策略。


## 目录
- 规则概述
- 核心规则
- 异常处理
- 规则引用关系

---

## 规则概述

```yaml
规则名称: 大型项目扩展规则
适用范围: 项目分析阶段
核心职责:
  - 判定项目是否达到大型项目规模
  - 制定文档分片策略
  - 管理分批处理流程
  - 优化大型项目读取策略
```

---

<large_project_rules>
## 核心规则

### 大型项目规模判定

> 📌 规则引用: 本规则在项目分析阶段执行，不影响复杂度判定。复杂度判定仅基于需求描述推断，不扫描项目目录。

<scale_detection>
大型项目判定推理过程:
1. 在项目分析阶段扫描项目结构
2. 统计源代码文件数量、代码行数、模块数
3. 判断是否满足大型项目条件
4. 满足条件时启用文档分片策略
</scale_detection>

```yaml
触发时机: 项目分析阶段
用途: 判断是否需要启用文档分片策略

判定条件（满足任一）:
  - 源代码文件 > 500
  - 代码行数 > 50000
  - 模块数 > 30

判定方式:
  自动判定: 项目分析阶段扫描项目时自动评估
  手动验证: project_stats.py [--path <项目路径>]

注意: 此判定与复杂度判定（微调/轻量迭代/标准开发）无关
```

> 📌 规则引用: 脚本路径规则见 references/rules/tools.md

### 文档分片规则

<sharding_rules>
文档分片策略:
1. CHANGELOG: 按年份分片，主文件保留当前年份
2. modules/: 按类型分类（core/feature/shared）
3. archive/_index: 按年份分片
</sharding_rules>

```yaml
KB_CREATE_MODE 与分片的关系:
  KB_CREATE_MODE = 0 (OFF):
    - 跳过分片评估和执行
    - 原因: 知识库写操作已禁用，分片无意义
  KB_CREATE_MODE = 1/2/3:
    - 正常执行分片评估
    - 满足条件时自动执行分片

CHANGELOG（条目>200时）:
  - 按年份分片到 CHANGELOG_{YYYY}.md
  - 主文件保留当前年份 + Unreleased
  - 分片触发: ~init/~upgrade 或开发实施阶段检测到条件

modules/（模块>30时）:
  - 按类型分类: core/, feature/, shared/
  - 每个分类下独立 _index.md
  - 分片触发: ~init/~upgrade 执行时

archive/_index（归档>200或跨年时）:
  - 按年份分片: _index-{YYYY}.md
  - 分片触发: 方案包迁移时自动判定
```

### 分批处理

<batch_processing>
分批处理规则:
1. 检测任务涉及的模块数量
2. 超过20个模块时启用分批
3. 优先处理核心模块和高依赖模块
4. 批次间输出进度报告
</batch_processing>

```yaml
触发条件: 任务涉及模块数 > 20

处理方式:
  - 每批 ≤ 20 个模块
  - 优先处理核心模块和高依赖模块
  - 批次间输出进度
```

### 读取策略

```yaml
原则:
  - 先读索引文件快速定位
  - 按需加载具体文档
  - 避免一次性读取所有文件
```
</large_project_rules>

---

## 异常处理

```yaml
规模统计失败:
  - 脚本不可用时使用内置逻辑估算
  - 无法确定时按非大型项目处理
  - 输出警告，建议手动确认

分片操作失败:
  - 保持原文件不变
  - 输出错误详情
  - 建议手动执行分片

分批处理中断:
  - 记录已完成批次
  - 提供继续选项
  - 支持从断点恢复
```

---

## 规则引用关系

```yaml
被引用:
  - 项目分析阶段（规模判定）
  - ~init 命令（知识库初始化分片）
  - ~upgrade 命令（知识库升级分片）

引用:
  - references/rules/tools.md（脚本路径规则）
  - references/services/knowledge.md（CHANGELOG更新规则）
```
